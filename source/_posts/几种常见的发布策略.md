---
title: 几种常见的发布策略
categories: kubernetes
date: 2020-12-13 10:05:03
---

本文主要介绍Kubernetes中经常使用到的几种发布策略，如蓝绿发布、红黑发布、金丝雀（灰度）发布、滚动发布等。

<!--more-->



## 蓝绿发布

蓝绿发布是一种平滑过渡的发布策略，通过在生产环境中同时运行两个版本的应用（旧版本为“蓝色”环境，新版本为“绿色”环境），逐步将用户流量从旧版本转移到新版本。在流量完全切换到绿色环境后，蓝色环境可以保持待机状态，以备回滚之需，或者作为下次更新的基础模板。

### 工作流程

部署新版本（绿色环境），与旧版本（蓝色环境）并行运行。
逐步将用户流量从蓝色环境切换到绿色环境。
确认新版本稳定后，停止蓝色环境。
### 优点
- 快速升级和回滚：如果新版本出现问题，可以迅速切换回旧版本。

### 缺点：
- 资源占用：在切换过程中，旧版本的环境仍需保持运行，资源利用率暂时降低。
- 不适合高峰期：由于资源减少，业务高峰期使用此策略可能导致服务过载。
- 应用场景：适用于需要快速回滚且对资源占用不敏感的场景，如非高峰期的应用更新。

![](https://weiblog-1252613377.cos.ap-chengdu.myqcloud.com/20221213010921.png)



## 红黑发布

红黑发布（也称A/B测试）与蓝绿发布类似，但侧重于通过两个独立环境完成版本升级。当前生产环境为“红色”环境，新版本部署在“黑色”环境。与蓝绿发布不同，红黑发布在切换时会直接将流量指向新环境，并删除旧环境，过程中需要两倍的资源。

### 工作流程
部署新版本到黑色环境（Group2）。
将负载均衡器指向黑色环境（Group2）。
删除旧版本的红色环境（Group1）。

### 优点
- 快速切换：一次性将流量切换到新版本，适合需要快速更新的场景。

### 缺点
- 资源消耗大：在部署过程中需要同时维护两个环境，资源占用翻倍。
- 回滚复杂：一旦删除旧环境，回滚操作较为复杂。
- 应用场景：适用于资源充足且对回滚需求不高的场景，如内部测试或小型应用。

![](https://weiblog-1252613377.cos.ap-chengdu.myqcloud.com/20221213012144.png)



## 金丝雀发布

金丝雀发布（灰度发布）是一种渐进式的发布策略，在生产环境中同时运行新旧两个版本，部分用户使用旧版本（v1），部分用户使用新版本（v2），通过逐步增加新版本的用户比例来验证其稳定性。

### 工作流程

- 部署新版本（v2），与旧版本（v1）共存。 
- 将少量用户流量（例如10%）导向新版本，观察其表现。 
- 如果新版本稳定，逐步增加其流量比例，直至100%。

### 优点

风险低：通过小范围测试新版本，减少大规模故障的风险。
用户反馈：可以根据早期用户的反馈及时调整。

### 缺点

管理复杂：需要精确控制流量分配，配置较为复杂。
应用场景：适用于对稳定性要求高、需要用户反馈的场景，如Web应用或API服务。

![](https://weiblog-1252613377.cos.ap-chengdu.myqcloud.com/20221213012102.png)



## 滚动发布

滚动发布是金丝雀发布的自动化改进版本，通过逐步替换旧版本的实例为新版本，实现平滑升级。在Kubernetes中，滚动发布通过控制副本集（ReplicaSet）来管理新旧版本的实例数量，确保在升级过程中服务不中断。

### 工作流程

启动少量新版本实例，同时停止等量的旧版本实例。
确认新版本实例运行正常后，继续替换更多实例。
重复此过程，直至所有实例升级为新版本。

### 优点

- 自动化程度高：Kubernetes原生支持，易于配置。
- 零停机时间：通过逐步替换实例，确保服务持续可用。
- 易于回滚：如果检测到问题，可以快速回滚到旧版本。

### 缺点

- 升级速度较慢：对于大规模集群，滚动升级可能耗时较长。
- 应用场景：适用于大多数生产环境，是Kubernetes中最主流的发布策略。

![](https://weiblog-1252613377.cos.ap-chengdu.myqcloud.com/20221213012220.png)


## 参考资料

1. [Red Hat - 什么是蓝绿部署](https://www.redhat.com/zh/topics/devops/what-is-blue-green-deployment)
2. [Container Solutions - Kubernetes Deployment Strategies](https://blog.container-solutions.com/kubernetes-deployment-strategies)
3. [Kubernetes部署策略详解](https://www.cnblogs.com/hunternet/p/14306105.html)
